import pandas as pd
import matplotlib.pyplot as plt
from sklearn.metrics import r2_score
from xgboost import XGBRegressor
from pathlib import Path


def plot_xgb_true_vs_pred():
    print("=== Plot XGBoost : True vs Predicted Gini ===")

   
    results_dir = Path("results")
    results_dir.mkdir(exist_ok=True)

    X_train = pd.read_csv(results_dir / "X_train.csv")
    X_test  = pd.read_csv(results_dir / "X_test.csv")
    y_train = pd.read_csv(results_dir / "y_train.csv")
    y_test  = pd.read_csv(results_dir / "y_test.csv")

    y_train = y_train.values.ravel()
    y_test = y_test.values.ravel()

 
    model = XGBRegressor(
        n_estimators=400,
        max_depth=4,
        learning_rate=0.05,
        subsample=0.8,
        colsample_bytree=0.8,
        objective="reg:squarederror",
        random_state=42,
        n_jobs=-1,
    )

   
    model.fit(X_train, y_train)

    
    y_pred = model.predict(X_test)

    
    r2 = r2_score(y_test, y_pred)

   
    plt.figure(figsize=(6, 6))
    plt.scatter(y_test, y_pred, alpha=0.5)

   
    min_val = min(y_test.min(), y_pred.min())
    max_val = max(y_test.max(), y_pred.max())
    plt.plot([min_val, max_val], [min_val, max_val])

    plt.xlabel("Gini real")
    plt.ylabel("Gini predicted (XGBoost)")
    plt.title(f"XGBoost – Gini real vs predicted (R² = {r2:.3f})")

    plt.tight_layout()

    
    output_path = results_dir / "xgb_true_vs_pred.png"
    plt.savefig(output_path, dpi=300)
    print(f"Figure saved in : {output_path}")

    plt.show()


if __name__ == "__main__":
    plot_xgb_true_vs_pred()
